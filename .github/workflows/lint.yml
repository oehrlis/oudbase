# ------------------------------------------------------------------------------
# OraDBA - Oracle Database Infrastructure and Security, 5630 Muri, Switzerland
# ------------------------------------------------------------------------------
# Name.......: lint.yml
# Author.....: Stefan Oehrli (oes) stefan.oehrli@oradba.ch
# Editor.....: Stefan Oehrli
# Date.......: 2025.12.12
# Version....: v4.0.0
# Purpose....: Lint and format checks for fast feedback on PRs
# Notes......: Triggered on pull_request and push to main/dev
# Reference..: https://github.com/oehrlis/oudbase
# License....: Apache License Version 2.0, January 2004 as shown
#              at http://www.apache.org/licenses/
# ------------------------------------------------------------------------------
# Modified...:
# see git revision history with git log for more information on changes
# ------------------------------------------------------------------------------
on:
  pull_request:
  push:
    branches:
      - main
      - dev

jobs:
  shfmt-check:
    name: shfmt --check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install shfmt
        run: |
          sudo apt-get update -y
          sudo apt-get install -y golang-go
          GO111MODULE=on go install mvdan.cc/sh/v3/cmd/shfmt@latest
          export PATH="$PATH:$HOME/go/bin"
          shfmt --version
      - name: Run shfmt (check)
        run: |
          # adjust globs to match your scripts
          set -o pipefail
          files=$(git ls-files '*.sh' 'src/bin/*' 'scripts/*.sh' 'test/bats/*.bash' || true)
          if [ -z "$files" ]; then
            echo "No shell files found"
            exit 0
          fi
          echo "$files" | xargs shfmt -d || (echo "Run 'make fmt' to fix" && exit 1)

  shellcheck:
    name: shellcheck
    runs-on: ubuntu-latest
    needs: shfmt-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install shellcheck
        run: |
          sudo apt-get update -y
          sudo apt-get install -y shellcheck
          shellcheck --version
      - name: Run shellcheck
        run: |
          files=$(git ls-files '*.sh' 'src/bin/*' 'scripts/*.sh' 'test/bats/*.bash' || true)
          if [ -z "$files" ]; then
            echo "No shell files found"
            exit 0
          fi
          # run shellcheck in parallel-ish
          echo "$files" | xargs -n1 shellcheck -x || (echo "shellcheck issues found" && exit 1)